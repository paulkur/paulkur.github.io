---
title: Proxmox Setup
date: 2023-05-13 12:53:00 +0100
categories: [homelab,hardware,setup,proxmox]
tags: [servers,docs,proxmox,setup]     # TAG names should always be lowercase

---

## Links

- [Links](#links)
  - [Proxmox Setup](#proxmox-setup)
- [Cloud-init setup](#cloud-init-setup)
- [Terraform setup terraform proxmox providers](#terraform-setup-terraform-proxmox-providers)
- [openWRT setup on x86 PC](#openwrt-setup-on-x86-pc)
- [PROXMOX Mount Drives](#proxmox-mount-drives)
- [Extras](#extras)
- [NFS share mount on Windows](#nfs-share-mount-on-windows)

Useful links:

- [usefull comands](https://www.youtube.com/watch?v=lZjMxdBPH7M&t=917s)
- [Proxmox Setup](https://www.youtube.com/watch?v=GoZaMgEgrHw)

### Proxmox Setup

- non production updates

```bash
nano /etc/apt/sources.list
```

```bash
## PVE pve-no-subscription repository provided by proxmox.com, NOT recommended for production use
deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription
```

- comment out line:

```bash
nano /etc/apt/sources.list.d/pve-enterprise.list
```

- Update all

```bash
apt-get update && apt dist-upgrade
pveam update && reboot
```

{% include embed/youtube.html id='GoZaMgEgrHw' %}

- Proxmox Dark

```bash
bash <(curl -s https://raw.githubusercontent.com/Weilbyte/PVEDiscordDark/master/PVEDiscordDark.sh ) install
```

## Cloud-init setup

{% include embed/youtube.html id='shiIi38cJe4&t=333s' %}

- Ubuntu get cloud image

```bash
wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
```

- can do ... or better later using ansible

```bash
virt-edit -a jammy-server-cloudimg-amd64.img /etc/ssh/ssh_config
```

change to:

```text
PermitRootLogin Yes
PasswordAuthentication yes
```

- Create VM template

```bash
qm create 8000 --memory 2048 --core 2 --name ubuntu-cloud --net0 virtio,bridge=vmbr0
qm importdisk 8000 jammy-server-cloudimg-amd64.img local-lvm
qm set 8000 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-8000-disk-0
qm set 8000 --ide2 local-lvm:cloudinit
qm set 8000 --boot c --bootdisk scsi0
qm set 8000 --serial0 socket --vga serial0
qm template 8000
qm clone 8000 131 --name yoshi --full
```

- Rocky WSL init

```bash
# for WSL need to run this
sudo apt-get install linux-image-generic
# Install libguestfs
apt-get install libguestfs-tools
export EDITOR=vi # Set the Editor
printenv | grep EDITOR # Verify
```

Rocky Cloud image

```bash
wget https://download.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
```

Modify image

```bash
virt-edit -a Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 /etc/cloud/cloud.cfg
# change to 0
disable_root: 0
#add modules
cloud_init_modules:
 - qemu-guest-agent
 - nano
 - wget
 - curl
 - net-tools
```

Create Template

```bash
virt-edit -a Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 /etc/ssh/ssh_config
# change to
PermitRootLogin Yes
PasswordAuthentication yes
# make  template
qm create 9000 --memory 1024 --core 2 --name rocky-cloud --net0 virtio,bridge=vmbr0
qm importdisk 9000 Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 local-lvm
qm set 9000 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9000-disk-0
qm set 9000 --ide2 local-lvm:cloudinit
qm set 9000 --boot c --bootdisk scsi0
qm set 9000 --serial0 socket --vga serial0
qm template 9000
qm clone 9000 141 --name toshi --full
```

## Terraform setup [terraform proxmox providers](https://registry.terraform.io/providers/Telmate/proxmox/latest/docs)

- terraform add new proxmox user

```bash
pveum role add TerraformProv -privs "Datastore.AllocateSpace Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate VM.Monitor VM.PowerMgmt"
pveum user add terraform-prov@pam --password natoMagic7812
pveum aclmod / -user terraform-prov@pam -role TerraformProv
```

- Create a new role for the future terraform user

```bash
pveum role add TerraformProv -privs "Datastore.AllocateSpace Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate VM.Monitor VM.PowerMgmt"
```

- Create the user "terraform-prov@pve"

```bash
pveum user add terraform-prov@pam --password <password>
```

- Add the TERRAFORM-PROV role to the terraform-prov user

```bash
pveum aclmod / -user terraform-prov@pam -role TerraformProv
```

- After the role is in use, if there is a need to modify the privileges, simply issue the command showed, adding or removing privileges as needed.

```bash
pveum role modify TerraformProv -privs "Datastore.AllocateSpace Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate VM.Monitor VM.PowerMgmt"
```

- VMS-qemu template proxmox from terraform.io

```bash
resource "proxmox_vm_qemu" "resource-name" {
  name        = "VM-name"
  target_node = "Node to create the VM on"
  iso         = "ISO file name"

  ### or for a Clone VM operation
  # clone = "template to clone"

  ### or for a PXE boot VM operation
  # pxe = true
  # boot = "scsi0;net0"
  # agent = 0
}
```

## openWRT setup on x86 PC

- download image

```bash
wget https://downloads.openwrt.org/releases/22.03.5/targets/x86/64/openwrt-22.03.5-x86-64-generic-ext4-combined.img.gz
gunzip openwrt-22.03.5-x86-64-generic-ext4-combined.img.gz
lsblk
sudo mkfs -t ext4 /dev/sda
# Write image
dd if=openwrt-22.03.5-x86-64-generic-ext4-combined.img bs=1M of=/dev/sda
parted /dev/sda print
parted -s /dev/sda resizepart 2 100%
resize2fs /dev/sda2
```

- we are installing by default

```bash
opkg update && opkg install kmod-pcengines-apuv2 beep kmod-leds-gpio kmod-crypto-hw-ccp kmod-usb-core kmod-usb-ohci kmod-usb2 kmod-usb3 kmod-sound-core kmod-pcspkr amd64-microcode flashrom irqbalance fstrim usbutils curl luci-app-advanced-reboot
```

```bash
opkg update && opkg install block-mount e2fsprogs kmod-fs-ext4 kmod-usb-storage kmod-usb2 kmod-usb3 hdparm luci-app-hd-idle gdisk libblkid nfs-kernel-server nano
```

- If you have wle200nx, wle600vx or wle900vx WiFI adapters : hostapd-openssl

```bash
opkg install kmod-ath9k ath9k-htc-firmware ath10k-firmware-qca988x kmod-ath10k hostapd-openssl 
```

- If you have a Quectel 4G modem

```bash
opkg install qmi-utils kmod-usb-net-qmi-wwan libqmi luci-proto-qmi uqmi
```

- If you want to run Wireguard

```bash
opkg install luci-proto-wireguard luci-app-wireguard
```

- And here are packages for OpenVPN

```bash
opkg install openvpn-openssl ip-full luci-app-openvpn
```

check connection status

```bash
uqmi -d /dev/cdc-wdm0 --get-data-status
```

check sim status

```bash
qmicli --device=/dev/cdc-wdm0 --device-open-proxy --uim-get-card-status
```

## [PROXMOX Mount Drives](https://www.youtube.com/watch?v=lZjMxdBPH7M&t=917s)

- Mount USB disk

```bash
lsblk
lsusb
fdisk -l
sudo mkfs -t ext4 /dev/sdb1
mkdir /mnt/usb-drive

# get UUID 
ls -l /dev/disk/by-uuid/*
nano /etc/fstab
## add line
/dev/disk/by-uuid/DISK_UUID  /mnt/m2drive  exfat    defaults    0
df -h
mount -a
```

## Extras

- KILL stuck VM. get PID

```bash
ps aux | grep "/usr/bin/kvm -id VMID"
kill -9 PID
```

- Mount drive to container

```bash
nano /etc/pve/lxc/100.conf
mp0: /mnt/mydisk,mp=/mydisk
mp1: /mnt/m2drive,mp=/mnt/m2drive-mnt
```

- in windows explorer type in

```bash
\\IP_ADDRESS\mnt\pve\sdd-data
```

## NFS share mount on Windows

- correct registry

1. Open regedit by typing it in the search box end pressing Enter
2. Browse to 'HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ClientForNFS\CurrentVersion\Default'
3. Create a new New DWORD (32-bit) Value inside the Default folder named 'AnonymousUid' and assign the UID found on the UNIX directory as shared by the NFS system
4. Create a new New DWORD (32-bit") Value inside the Default folder named AnonymousGid and assign the GID found on the UNIX directory as shared by the NFS system.

- the following command will mount a share on the NFS system at /mnt/vms

```cmd
mount \\<IP_ADDRESS>\<PATH_TO_DIR>\ drive:
mount \\<IP_ADDRESS>\mnt\backups Z:
```

- NFS Share on openWRT setup

```bash
uci set network.lan.ipaddr='192.168.0.201'
/mnt/backups/ *(rw,all_squash,insecure,no_subtree_check,fsid=0)
/mnt/m2drive/ *(rw,all_squash,insecure,no_subtree_check,fsid=0)
/mnt/internal/ *(rw,all_squash,insecure,no_subtree_check,fsid=0)
```

- [iGPU Full Passthrough](https://3os.org/infrastructure/proxmox/gpu-passthrough/igpu-passthrough-to-vm/#proxmox-configuration-for-igpu-full-passthrough)

```bash
nano /etc/default/grub

GRUB_CMDLINE_LINUX_DEFAULT="quiet"
# change to:
GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on"
# for CPU

GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt pcie_acs_override=downstream,multifunction initcall_blacklist=sysfb_init video=simplefb:off video=vesafb:off video=efifb:off video=vesa:off disable_vga=1 vfio_iommu_type1.allow_unsafe_interrupts=1 kvm.ignore_msrs=1 modprobe.blacklist=radeon,nouveau,nvidia,nvidiafb,nvidia-gpu,snd_hda_intel,snd_hda_codec_hdmi,i915"

nano /etc/modules

vifo
vfio_iommu_type1
vifo_pci
cifo_virqfd
```
